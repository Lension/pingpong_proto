name: Generate Protobuf Files

on: [push]

jobs:
  generate:
    name: generate protobuf files
    runs-on: ubuntu-latest
    steps:
      - name: clone repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: install protoc
        uses: arduino/setup-protoc@v2
        with:
          version: '24.x'
      - name: install dart
        uses: dart-lang/setup-dart@v1
      - name: generate dart file
        run: |
          dart pub global activate protoc_plugin
          export PATH=$PATH:~/.pub-cache/bin
          protoc --proto_path=pb --dart_out=dart/lib/protos pb/*.proto
      - name: install plugin and generate
        run: |
          export GOPATH=$HOME/go
          export GOBIN=$GOPATH/bin
          export PATH=$PATH:$GOROOT:$GOPATH:$GOBIN
          go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.26
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.3
          echo $(find $PROTO_DIR -type f -name '*.proto')
          protoc -I=$PROTO_DIR  --go_out=$GEN_OUT_DIR  --go-grpc_out=$GEN_OUT_DIR  $(find $PROTO_DIR -type f -name '*.proto')
          python build/build-go-pb.py
        env:
          GEN_OUT_DIR: actions/build/go
          PROTO_DIR: pb
      - name: Commit files
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -a -m "Add changes"
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

