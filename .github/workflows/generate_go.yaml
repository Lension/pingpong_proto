name: Generate In Go

on: [push]

jobs:
  proto_checks:
    name: proto lint, breaking changes detection and generating stubs from protos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0
      - uses: arduino/setup-protoc@v2
        with:
          version: '24.x'
      - name: Fetching base branch
        run: |
          git fetch -u origin ${{ github.base_ref }}:${{ github.base_ref }}
      - name: Installing protoc-gen-go
        run: |
          export GOPATH=$HOME/go
          export GOBIN=$GOPATH/bin
          export PATH=$PATH:$GOROOT:$GOPATH:$GOBIN
          go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.26
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.3
          echo $(find $PROTO_DIR -type f -name '*.proto')
          protoc -I=$PROTO_DIR  --go_out=$GEN_OUT_DIR  --go-grpc_out=$GEN_OUT_DIR  $(find $PROTO_DIR -type f -name '*.proto')
          ls $GEN_OUT_DIR
        env:
          GEN_OUT_DIR: actions/build/go
          PROTO_DIR: pb
      - name: Commit files
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -a -m "Add changes"
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

